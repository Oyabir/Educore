{% extends "platformTK/Prof/HomeBase.html" %}
{% load static %}
{% load custom_filters %}

{% block content %}
{% include 'platformTK/Prof/navbar.html' %}

    <!-- Filter Form Start -->
    <div class="container-xxl py-5">
        <div class="container">
            <!-- Students List Start -->
            <div class="text-center mx-auto mb-5 wow fadeInUp" data-wow-delay="0.1s" style="max-width: 600px;">
                <h1 class="mb-3">Students of {{ group.name }}</h1>
            </div>
            <form method="get" class="mb-4">
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" name="prenom" placeholder="Filter by Prenom" value="{{ request.GET.prenom }}">
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" name="nom" placeholder="Filter by Nom" value="{{ request.GET.nom }}">
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" name="code" placeholder="Filter by Code Etudiant" value="{{ request.GET.code }}">
                    </div>
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary" style="background-color: #176b90;border-color: #176b90;">Apply Filters</button>
                        <a href="{% url 'RÃ©partition_points' code_group=group.code_group %}" class="btn btn-secondary">Cancel Filter</a>
                    </div>
                </div>
            </form>
            <div class="row g-4">
                {% for student in students %}
                    <div class="col-lg-4 col-md-6 wow fadeInUp" data-wow-delay="0.1s">
                        <div class="classes-item">
                            <div class="bg-light rounded-circle w-75 mx-auto p-3">
                                <img class="img-fluid rounded-circle" src="img/classes-1.jpg" alt="">
                            </div>
                            <div class="bg-light rounded p-4 pt-5 mt-n5">
                                <a class="d-block text-center h3 mt-3 mb-4" href="">{{ student.prenom }} {{ student.nom }}</a>
                                <div class="d-flex align-items-center justify-content-between mb-4">
                                    <div class="d-flex align-items-center">
                                        {% if student.avatar %}
                                        <img class="rounded-circle flex-shrink-0" src="{{ student.avatar.url }}" alt="" style="width: 55px;height: 55px;">
                                        {% else %}
                                        <img class="rounded-circle flex-shrink-0" src="{% static 'img/user.jpg' %}" alt="" style="width: 55px;height: 55px;">
                                        {% endif %}
                                        <div class="ms-3">
                                            <h6 class="text-primary mb-1" style="color: #30bb96 !important;">{{ student.prenom }} {{ student.nom }}</h6>
                                            <small>{{ student.EtudiantCode }}</small>
                                        </div> 
                                    </div>
                                    <span class="bg-primary text-white rounded-pill py-2 px-3" style="background-color: #176b90 !important;">
                                        ${{ memberships_dict|get_item:student.id }}
                                    </span>
                                </div>
                                <div class="row g-1">
                                    <div class="col-4">
                                        <div class="border-top border-3 border-primary pt-2" style="border-color: #103741 !important;">
                                            <h6 class="text-primary mb-1">Add:</h6>
                                            <small>
                                                <button type="button" 
                                                        class="bg-primary text-white rounded-pill py-2 px-3" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#addItemModal" 
                                                        data-student-id="{{ student.id }}" 
                                                        data-group-id="{{ group.id }}" 
                                                        style="background-color: #176b90 !important;">Add</button>
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-4"></div>
                                    <div class="col-4">
                                        <div class="border-top border-3 border-warning pt-2" style="border-color: #103741 !important;">
                                            <h6 class="text-warning mb-1">Minus:</h6>
                                            <small>
                                                <button type="button" 
                                                        class="bg-primary text-white rounded-pill py-2 px-3" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#minusItemModal" 
                                                        data-student-id="{{ student.id }}" 
                                                        data-group-id="{{ group.id }}" 
                                                        style="background-color: #176b90 !important;">Minus</button>
                                            </small>                                    
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                {% if not students %}
                <p>No students found matching your search.</p>
                {% endif %}
            </div>
        </div>
    </div>


                    <style>
                        .win-animation {
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            text-align: center;
                            width: 300px;
                            z-index: 1055; /* Higher than modal */
                            background: rgba(255, 255, 255, 0.95); /* Slightly opaque background */
                            padding: 20px;
                            border-radius: 15px;
                            box-shadow: 0 0 25px rgba(0, 0, 0, 0.5);
                            animation: fadeIn 0.5s ease-out;
                            overflow: hidden; /* Hide overflowing elements */
                        }
                        
                        .animation-container {
                            position: relative;
                            height: 300px; /* Ensure the container is tall enough to accommodate falling elements */
                        }
                        
                        .trophy-icon {
                            font-size: 6rem;
                            color: gold;
                            animation: sparkle 2s ease-in-out infinite;
                        }
                        
                        .confetti-container {
                            position: absolute;
                            top: 20%;
                            left: 50%;
                            transform: translateX(-50%);
                            width: 100%;
                            height: 100%;
                            overflow: hidden;
                        }
                        
                        .confetti-emoji {
                            display: flex;
                            justify-content: center;
                            position: absolute;
                            transform: translateX(-50%);
                            font-size: 3rem;
                            animation: emojiMove 3s linear infinite;
                        }
                        
                        .confetti-emoji span {
                            display: inline-block;
                            margin: 0 10px; /* Space between emojis */
                        }
                        
                        .confetti {
                            position: absolute;
                            width: 100%;
                            height: 100%;
                            overflow: hidden;
                            top: 0;
                            left: 0;
                        }
                        
                        .confetti-piece {
                            position: absolute;
                            width: 10px;
                            height: 10px;
                            background-color: #f00;
                            opacity: 0.8;
                            animation: confetti 3s linear infinite;
                        }
                        
                        .confetti-piece:nth-child(1) {
                            background-color: #ff0;
                            left: 10%;
                            animation-delay: 0s;
                        }
                        
                        .confetti-piece:nth-child(2) {
                            background-color: #0f0;
                            left: 30%;
                            animation-delay: 0.2s;
                        }
                        
                        .confetti-piece:nth-child(3) {
                            background-color: #00f;
                            left: 50%;
                            animation-delay: 0.4s;
                        }
                        
                        .confetti-piece:nth-child(4) {
                            background-color: #f0f;
                            left: 70%;
                            animation-delay: 0.6s;
                        }
                        
                        .confetti-piece:nth-child(5) {
                            background-color: #0ff;
                            left: 90%;
                            animation-delay: 0.8s;
                        }
                        
                        .stars {
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            overflow: hidden;
                        }
                        
                        .star {
                            position: absolute;
                            width: 15px;
                            height: 15px;
                            background: radial-gradient(circle, #fff, transparent);
                            border-radius: 50%;
                            box-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
                            animation: starFall 5s linear infinite;
                        }
                        
                        .star:nth-child(1) {
                            top: 10%;
                            left: 10%;
                            animation-delay: 0s;
                        }
                        
                        .star:nth-child(2) {
                            top: 20%;
                            left: 30%;
                            animation-delay: 1s;
                        }
                        
                        .star:nth-child(3) {
                            top: 40%;
                            left: 50%;
                            animation-delay: 2s;
                        }
                        
                        .star:nth-child(4) {
                            top: 60%;
                            left: 70%;
                            animation-delay: 3s;
                        }
                        
                        .star:nth-child(5) {
                            top: 80%;
                            left: 90%;
                            animation-delay: 4s;
                        }
                        
                        .d-none {
                            display: none;
                        }
                        
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                        
                        @keyframes sparkle {
                            0%, 100% {
                                text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
                            }
                            50% {
                                text-shadow: 0 0 30px rgba(255, 215, 0, 1);
                            }
                        }
                        
                        @keyframes confetti {
                            0% {
                                transform: translateY(-1000px) rotate(0deg);
                            }
                            100% {
                                transform: translateY(1000px) rotate(360deg);
                            }
                        }
                        
                        @keyframes emojiMove {
                            0% {
                                transform: translateY(-100px);
                                opacity: 1;
                            }
                            50% {
                                transform: translateY(0px);
                                opacity: 1;
                            }
                            100% {
                                transform: translateY(100px);
                                opacity: 0;
                            }
                        }
                        
                        @keyframes starFall {
                            0% {
                                transform: translateY(-100vh);
                                opacity: 1;
                            }
                            100% {
                                transform: translateY(100vh);
                                opacity: 0;
                            }
                        }
                        
                    </style>

<!-- Add Item Modal -->
<div id="addItemModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addItemModalLabel">Select Amount to Add</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPointsForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="dropdownAmount" class="form-label">Choose an amount</label>
                        <select class="form-select" id="dropdownAmount" aria-label="Amount select">
                            <option selected>Select an amount</option>
                            <option value="1">1$</option>
                            <option value="5">5$</option>
                            <option value="10">10$</option>
                        </select>
                    </div>
                </form>                                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="triggerAnimation()" style="background-color: #0b3548;border-color: #ffffff;">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Winning Animation -->
<div id="winAnimation" class="win-animation d-none">
    <div class="animation-container">
        <div class="trophy-icon">ð</div>
        <div class="confetti-container">
            <div class="confetti-emoji">
                <span>ð</span>
                <span>ð</span>
                <span>ð</span>
            </div>
            <div class="confetti">
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
            </div>
        </div>
        <div class="stars">
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
        </div>
    </div>
</div>

<!-- Winning Sound -->
<audio id="winningSound" src="{% static 'mixkit-small-group-moderate-applause-505.wav' %}" preload="auto"></audio>

<!-- Minus Item Modal -->
<div id="minusItemModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="minusItemModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="minusItemModalLabel">Select Amount to Subtract</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="minusPointsForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="dropdownMinusAmount" class="form-label">Choose an amount</label>
                        <select class="form-select" id="dropdownMinusAmount" aria-label="Amount select">
                            <option selected>Select an amount</option>
                            <option value="1">-1$</option>
                            <option value="5">-5$</option>
                            <option value="10">-10$</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="triggerLossAnimation()" style="background-color: #0b3548;border-color: #ffffff;">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Loss Animation -->
<div id="lossAnimation" class="win-animation d-none">
    <div class="animation-container">
        <div class="sad-face">ð</div>
        <div class="confetti-container">
            <div class="confetti-emoji">
                <span>ð</span>
                <span>ð</span>
                <span>ð</span>
            </div>
            <div class="confetti">
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
            </div>
        </div>
        <div class="stars">
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
        </div>
    </div>
</div>

<!-- Loss Sound -->
<audio id="losingSound" src="{% static 'verloren-89595.mp3' %}" preload="auto"></audio>

<script>
    let selectedStudentId = null;
    let selectedGroupId = null; // Variable to store the selected group ID
    
    document.querySelectorAll('[data-bs-target="#addItemModal"], [data-bs-target="#minusItemModal"]').forEach(button => {
        button.addEventListener('click', function () {
            selectedStudentId = this.getAttribute('data-student-id');
            selectedGroupId = this.getAttribute('data-group-id');
            console.log('Selected Student ID:', selectedStudentId);
            console.log('Selected Group ID:', selectedGroupId);
        });
    });
    
    // Function to trigger the winning animation
    function triggerAnimation() {
        var selectedAmount = document.getElementById('dropdownAmount').value;
        console.log('Selected Amount (Add):', selectedAmount);
        if (selectedAmount && selectedAmount !== 'Select an amount') {
            bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
            document.getElementById('winAnimation').classList.remove('d-none');
            document.getElementById('winningSound').play();
            setTimeout(() => {
                document.getElementById('winAnimation').classList.add('d-none');
                location.reload();
            }, 6000);
    
            if (selectedStudentId && selectedGroupId) {
                fetch(`/update_points/${selectedStudentId}/${selectedGroupId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ amount: selectedAmount })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Success (Add):', data);
                })
                .catch((error) => {
                    console.error('Error (Add):', error);
                });
            } else {
                alert('No student or group selected.');
            }
        } else {
            alert('Please select a valid amount.');
        }
    }
    
    // Function to trigger the loss animation
    function triggerLossAnimation() {
        var selectedAmount = document.getElementById('dropdownMinusAmount').value;
        console.log('Selected Amount (Minus):', selectedAmount);
    
        if (selectedAmount && selectedAmount !== 'Select an amount') {
            var amount = parseInt(selectedAmount); 
            console.log('Parsed Amount:', amount);
            console.log('Selected Student ID (Minus):', selectedStudentId);
            console.log('Selected Group ID (Minus):', selectedGroupId);
    
            if (selectedStudentId && selectedGroupId) {
                fetch(`/subtract_points/${selectedStudentId}/${selectedGroupId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ amount: amount })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Points subtracted successfully');
                        bootstrap.Modal.getInstance(document.getElementById('minusItemModal')).hide();
                        document.getElementById('lossAnimation').classList.remove('d-none');
                        document.getElementById('losingSound').play();
                        setTimeout(() => {
                            document.getElementById('lossAnimation').classList.add('d-none');
                            location.reload();
                        }, 6000);
                    } else {
                        console.error('Error (Minus):', data.error);
                        alert('Failed to subtract points: ' + data.error);
                    }
                })
                .catch((error) => {
                    console.error('Error (Minus):', error);
                });
            } else {
                alert('No student or group selected.');
            }
        } else {
            alert('Please select a valid amount.');
        }
    }
    
    
</script>





<style>


    .win-animation {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        width: 300px;
        z-index: 1055; /* Higher than modal */
        background: rgba(255, 255, 255, 0.95); /* Slightly opaque background */
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 0 25px rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.5s ease-out;
        overflow: hidden; /* Hide overflowing elements */
    }

    .animation-container {
        position: relative;
        height: 300px; /* Ensure the container is tall enough to accommodate falling elements */
    }

    .sad-face {
        font-size: 6rem;
        color: #ff4d4d; /* Red color to signify sadness */
        animation: sadAnimation 2s ease-in-out infinite;
    }

    .confetti-container {
        position: absolute;
        top: 20%;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    .confetti-emoji {
        display: flex;
        justify-content: center;
        position: absolute;
        transform: translateX(-50%);
        font-size: 3rem;
        animation: emojiMove 3s linear infinite;
    }

    .confetti-emoji span {
        display: inline-block;
        margin: 0 10px; /* Space between emojis */
    }

    .confetti {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
        top: 0;
        left: 0;
    }

    .confetti-piece {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: #f00;
        opacity: 0.8;
        animation: confetti 3s linear infinite;
    }

    .confetti-piece:nth-child(1) {
        background-color: #ff0;
        left: 10%;
        animation-delay: 0s;
    }

    .confetti-piece:nth-child(2) {
        background-color: #0f0;
        left: 30%;
        animation-delay: 0.2s;
    }

    .confetti-piece:nth-child(3) {
        background-color: #00f;
        left: 50%;
        animation-delay: 0.4s;
    }

    .confetti-piece:nth-child(4) {
        background-color: #f0f;
        left: 70%;
        animation-delay: 0.6s;
    }

    .confetti-piece:nth-child(5) {
        background-color: #0ff;
        left: 90%;
        animation-delay: 0.8s;
    }

    .stars {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    .star {
        position: absolute;
        width: 15px;
        height: 15px;
        background: radial-gradient(circle, #fff, transparent);
        border-radius: 50%;
        box-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
        animation: starFall 5s linear infinite;
    }

    .star:nth-child(1) {
        top: 10%;
        left: 10%;
        animation-delay: 0s;
    }

    .star:nth-child(2) {
        top: 20%;
        left: 30%;
        animation-delay: 1s;
    }

    .star:nth-child(3) {
        top: 40%;
        left: 50%;
        animation-delay: 2s;
    }

    .star:nth-child(4) {
        top: 60%;
        left: 70%;
        animation-delay: 3s;
    }

    .star:nth-child(5) {
        top: 80%;
        left: 90%;
        animation-delay: 4s;
    }

    .d-none {
        display: none;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes sadAnimation {
        0%, 100% {
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.6);
        }
        50% {
            text-shadow: 0 0 20px rgba(255, 0, 0, 1);
        }
    }

    @keyframes confetti {
        0% {
            transform: translateY(-1000px) rotate(0deg);
        }
        100% {
            transform: translateY(1000px) rotate(360deg);
        }
    }

    @keyframes emojiMove {
        0% {
            transform: translateY(-100px);
            opacity: 1;
        }
        50% {
            transform: translateY(0px);
            opacity: 1;
        }
        100% {
            transform: translateY(100px);
            opacity: 0;
        }
    }

    @keyframes starFall {
        0% {
            transform: translateY(-100vh);
            opacity: 1;
        }
        100% {
            transform: translateY(100vh);
            opacity: 0;
        }
    }
</style>




                </div>
            </div>
        </div>
        <!-- Classes End -->
  
{% endblock  %}